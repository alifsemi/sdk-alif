def common_funcs
def samples1 = ['le_periph_blps', 'le_periph_cgms','le_periph_cpps','le_periph_cscps']

pipeline {
    agent any
    options {
        disableConcurrentBuilds(abortPrevious: true)
    }
    stages {
        stage('Checkout') {
            steps {
                checkout scm
                script {
                    common_funcs = load 'automation/ble_samples.groovy'
                }
            }
        }
        stage('initialize') {
            agent { label 'zas20' }
            options { skipDefaultCheckout() }
            steps {
                script {
                    common_funcs.initialize()
                }
            }
        }
        stage('verify_checkpatch') {
            agent { label 'zas20' }
            options { skipDefaultCheckout() }
            steps {
                script {
                    common_funcs.verify_checkpatch()
                }
            }
        }
        stage('verify_gitlint') {
            agent { label 'zas20' }
            options { skipDefaultCheckout() }
            steps {
                script {
                    common_funcs.verify_gitlint()
                }
            }
        }
        stage('BLE samples stage 1') {
            agent { label 'zas20' }
            options { skipDefaultCheckout() }
            steps {
                script {
                    samples1.each { sample ->
                        echo "Building sample: ${sample}"
                        common_funcs.build_ble(
                            "samples/bluetooth/${sample}",
                            "build-b1-${sample}",
                            "alif_b1_dk/ab1c1f4m51820ph0/rtss_he"
                        )
                    }
                }
            }
            post {
                success {
                    archiveArtifacts artifacts: '*.tar', fingerprint: true
                }
            }
        }
    }
}